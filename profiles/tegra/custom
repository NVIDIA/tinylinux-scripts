# Terminal on Tegra only goes to serial
sed -i "/^tty.*getty/d" "$NEWROOT"/etc/inittab
sed -i "/getty/s/38400/115200/ ; /getty/s/tty1/ttyS0/ ; /getty/s/-n/-L -n/" "$NEWROOT"/etc/inittab

# Additional packages
install_package sys-devel/gdb "client server xml"
install_package dev-util/valgrind
install_package dev-util/strace "aio"
install_package net-nds/ypbind
install_package net-fs/autofs "" "--nodeps"
install_package net-dialup/lrzsz
install_package net-libs/libpcap ipv6
install_package dev-libs/openssl "asm bindist tls-heartbeat zlib"
emerge --quiet --noreplace dev-util/meson dev-util/ninja # needed for libdrm
install_package x11-libs/libdrm

if istegra64; then # glib fails to cross compile for armv7
    # bluez dependencies
    NEWROOT=/ install_package docbook-xml-dtd:4.4           # Host dependency for building dbus
    NEWROOT=/ install_package app-text/xmlto                # Host dependency for building dbus
    "$TEGRAABI-emerge" --unmerge util-linux                 # Make room for rfkill (glib pulls util-linux)
    NEWROOT="/usr/$TEGRAABI" install_package sys-apps/dbus  # Host dependency for bluez
    install_package virtual/libffi                          # Dependency for glib
    install_package virtual/libiconv                        # Dependency for glib
    install_package virtual/libintl                         # Dependency for glib
    install_package dev-libs/libpcre                        # Dependency for glib
    install_package dev-libs/glib "" "--nodeps"             # Needed for bluez, avoid util-linux!

    install_package net-wireless/bluez "" "--nodeps"        # Avoid pulling dbus
    install_package net-wireless/rfkill
fi

# Set timezone
sed -i "/TZ/s/UTC/PST8PDT/" "$NEWROOT/etc/bash/bashrc"

# Extra config files
install_into /etc/conf.d boot hostname
rm -f "$NEWROOT/etc/autofs/auto.master"

# Update mdev config
echo "mods 0:30 660" >> "$NEWROOT/etc/mdev.conf"
sed -i "/MODALIAS/s/:0/:30/" "$NEWROOT/etc/mdev.conf"
